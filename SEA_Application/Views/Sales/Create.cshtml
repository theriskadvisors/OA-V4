
@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_CashierDashboardLayout.cshtml";
}

<style>
        th, td {
            padding: 5px;
        }

        /*@@media print {
            * {
                -webkit-print-color-adjust: exact !important;*/ /* Chrome, Safari, Edge */

        /*}
    }*/

        #SaleOrderTable tr, th, td {
            border: 0px !important;
        }

        .error {
            color: red !important;
        }

        #table1 td {
            width: 50%;
        }

        .description, .card-description, .footer-big p {
            color: black !important;
        }
</style>

<link href="~/Content/print-receipt-thermal-printer-master/print-receipt-thermal-printer-master/style.css" media="screen" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />


<div class="card">
    <div class="card-body p-4">

        <form method="post" id="SaleForm">

            <div class="col-md-5">


                @*<div class="form-group">

                        <div class="col-md-12">

                            <label class="control-label">Order No</label>

                            <input type="number" readonly id="OrderNo" name="OrderNo" value="@ViewBag.MaxId" class="form-control" required />

                        </div>
                    </div>*@

                <div class="col-md-12">

                    <label class="control-label">Date</label>

                    <input type="date" id="Date" name="Date" class="form-control" required />

                </div>

                <br />


                <div class="form-group">
                    <div class="col-md-12">

                        <label class="control-label">Description</label>

                        <textarea class="form-control" name="Description" id="Description" rows="5"></textarea>


                    </div>
                </div>
                <!--<br />
                <div class="form-group">
                    <div class="col-md-12">

                        <label class="control-label"> Customer Name</label>-->
                @*@Html.DropDownList("StudentID", null, " Select One", htmlAttributes: new { @class = "form-control drop", @id = "StudentID", required = "required" })*@

                <!--<input type="text" name="CustomerName" id="CustomerName" value="Customer" class="form-control" />

                    </div>
                </div>-->

            </div><!--end of column 6-->


            <br />

            <div class="col-md-12" id="SaleOrderBlock">

                <div class="col-md-12">


                    <table width="100%" id="SaleOrderTable" style="border:0px solid">

                        <thead>
                            <tr>


                                <td><label class="control-label">Select Item</label> </td>
                                <td><label class="control-label">Unit Name</label> </td>
                                <td><label class="control-label"> Unit Sale Price</label> </td>
                                <td><label class="control-label">Aailable Quantity </label> </td>
                                <td><label class="control-label">Quantity</label> </td>
                                <td><label class="control-label"> Total</label> </td>
                                <td><label class="control-label"> Action</label> </td>

                            </tr>

                        </thead>

                        <tbody>

                            <tr id="TableRow0">

                                <td style="width:20%">
                                    <select tabindex="1" style="width:200px;" class="form-control drop ItemInventoryDropDown" id="InventoryStocks0" name="InventoryStocks0" required></select>
                                </td>
                                <td>

                                    <input readonly class="form-control ItemSaleUnitName" id="UnitName0" type="text" name="UnitName0" />

                                </td>
                                <td style="width:15%">
                                    <input tabindex="2" class="form-control ItemSaleUnitPrice" id="SaleUnitPrice0" value="0" min="0" type="number" name="SaleUnitPrice0" required />
                                </td>

                                <td style="width:15%">

                                    <input readonly class="form-control ItemAvailableQuantity" id="AvailableQuantity0" value="0" type="number" name="AvailableQuantity0" required />
                                </td>

                                <td style="width:15%">
                                    <input tabindex="3" class="form-control ItemSelectionQuantity" id="StockQuantity0" value="1" type="number" min="1" name="StockQuantity0" required />
                                </td>


                                <td style="width:15%">
                                    <input type="number" id="TotalCost0" name="TotalCost0" class="form-control" readonly value="0" required />
                                </td>

                                <td style="width:15%">
                                    <button tabindex="4" type="button" style="background:#32CD32" id="" class="btn btn-sm btn-default " onclick="RawStock()"><i class="fa fa-plus" style="font-size:12px"></i></button>
                                </td>

                            </tr>


                            <tr id="GrandTotalRow">

                                <td style="width:20%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"> <label class="control-label"> Total</label></td>
                                <td style="width:15%"><input readonly style="text-align:right" class="form-control" value="0" min="0" type="number" id="GrandTotal" name="GrandTotal" required></td>
                                <td style="width:15%"></td>

                            </tr>


                            <tr id="DiscountRow">

                                <td style="width:20%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"> <label class="control-label">Discount Percentage (%)</label></td>
                                <td style="width:15%"><input style="text-align:right" class="form-control" value="0" min="0" type="number" id="Discount" name="Discount" required></td>
                                <td style="width:15%"></td>
                            </tr>

                            <tr id="DiscountRow">

                                <td style="width:20%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"> <label class="control-label">Discount Amount</label></td>
                                <td style="width:15%"><input style="text-align:right" class="form-control" value="0" min="0" readonly type="number" id="DiscountAmount" name="DiscountAmount" required></td>
                                <td style="width:15%"></td>
                            </tr>


                            <tr id="DiscountedPriceRow">

                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"></td>
                                <td style="width:15%"> <label class="control-label">Discounted Price</label></td>
                                <td style="width:15%"><input readonly style="text-align:right" class="form-control" value="0" min="0" type="number" id="DiscountedPrice" name="DiscountedPrice" required></td>
                                <td style="width:15%"></td>
                            </tr>


                        </tbody>

                    </table>

                    <span id="Error" style="color:red"></span>
                    <span id="Success" style="color:green"></span>


                </div>
            </div><!--col 12-->



            <div class="col-md-8">


                <div class="form-group">
                    <div class="col-md-12">
                        <button tabindex="99" type="submit" id="SaveButton" class="btn btn-primary rounded rounded-lg"> Save </button>


                        <button tabindex="100" type="button" id="btnCancel" class="btn btn-primary rounded rounded-lg bg-transparent text-muted shadow-none mr-3">
                            <i class="material-icons mr-2">cached</i>  Cancel
                        </button>

                    </div>
                </div>

            </div><!--end of col 8 -->

            <br />
            <div id="ReceiptBlock" style="display:none;">

                <div id="bill" style="display: none;">
                    <div class="ticket" id="ticket">
                        <center>
                            <img style="width: 150px;" src="/Content/assets/assets/img/Bis.png" alt="Alternate Text" />
                        </center>

                        <div id="ReceiptInner">


                        </div>


                    </div>
                </div>

            </div>


        </form>
    </div>
</div>

<script>

    count = 1;
    row = [];
    row[0] = 0;

    var arr = [];
    arr[0] = 0;

    // var FinishedProductsList = "";
    var ExternalAndProductionList = "";

    var ProductsObj =
    {


        ProductId: '',
        UnitName: '',
        Name: '',
        UnitSalePrice: '',
        QuantityOnHand: '',

    };

    ProductsObj = [
    ];



    $(document).ready(function () {




        $("#btnPrint").click(function () {

            $("#btnPrint").css('display', 'none');

            // alert(OrderType);

            var mywindow = window.open('', '', '');
            mywindow.document.write('<html><head><title>' + document.title + '</title>  ');
            mywindow.document.write('<style>td,th,tr,table{border-top: 1px solid black;} td.description,th.description {width: 90px; max-width: 90px;word-break: break-word;}  td.quantity,th.quantity{ width: 40px;max-width: 40px;word-break: break-all;} td.Amount,th.Amount {  width: 60px;max-width: 60px;word-break: break-all;} td.Amount,th.Amount {  width: 60px;max-width: 60px;word-break: break-all;} .centered {text-align: center;align-content: center;} .ticket{width: 230px;max-width:230px;font-size: 12px}  img {  max-width: inherit;  width: inherit;} </style>');
            mywindow.document.write('</head><body >');
            // mywindow.document.write('<h1>' + document.title + '</h1>');
            mywindow.document.write(document.getElementById('bill').innerHTML);
            // mywindow.document.write(document.getElementById('bill1').innerHTML);
            mywindow.document.write('</body></html>');
            mywindow.document.close(); // necessary for IE >= 10
            mywindow.focus(); // necessary for IE >= 10*/

            mywindow.print();
            mywindow.close();

        })

        $("#PageHeader").html("Sale Order");


        $(document).keyup(function (e) {

            // $("SPAN INPUT BUTTON").css('border-bottom', 'none');
            //$("SPAN INPUT BUTTON").css("border-bottom", 'none');
            $("SPAN,INPUT,BUTTON").css("border-bottom", "0");

            // $("SPAN").css("border-bottom", "1px solid gray");

            //.select2 - container--default .select2 - selection--single {
            //    background - color: #fff;
            //    border: 1px solid #aaa;
            //    border - radius: 4px;
            //}

            $(".select2-container--default .select2-selection--single").css('border', '1px solid #aaa');

            var focused = $(document.activeElement);

            var accessElement = focused;

            var TagName = $(accessElement).prop("tagName");

            if (TagName == "SPAN" || TagName == "BUTTON" || TagName == "INPUT") {

                accessElement.css('border-bottom', '2px solid black');
            }

        });

        //document.getElementById('Date').valueAsDate = new Date();

        var now = new Date();

        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);

        var today = now.getFullYear() + "-" + (month) + "-" + (day);

        //  document.getElementById('Date').valueAsDate = output;

        $("#Date").val(today);

        $(".drop").select2();


        $.ajax({
            type: "POST",
            cache: false,
            url: "/Sales/GetExternalAndProductionList",
            processData: false,
            contentType: false,
            success: function (data) {
                var sch = JSON.parse(data);
                console.log(sch);
                var $el = $("#InventoryStocks0");
                $el.empty();
                if (sch.length > 0) {
                    $el.append($("<option></option>")
                        .attr("value", "").text('Select Product'));
                    debugger
                    ExternalAndProductionList = ExternalAndProductionList + "<option value=''>Select Product</option>";

                    for (i = 0; i < sch.length; i++) {

                        var obj = {};


                        obj['ProductId'] = sch[i].Id;
                        obj['Name'] = sch[i].Name;
                        obj['UnitSalePrice'] = sch[i].UnitSalePrice;
                        obj['QuantityOnHand'] = sch[i].QuantityOnHand;
                        obj['UnitName'] = sch[i].UnitName;

                        ProductsObj.push(obj);

                        $el.append($("<option></option>")
                            .attr("value", sch[i].Id).text(sch[i].Name));

                        ExternalAndProductionList = ExternalAndProductionList + "<option value=" + sch[i].Id + ">" + sch[i].Name + "</option>";

                    }
                }
                else {
                    $el.append($("<option></option>")
                        .attr("value", '').text('Select'));
                }
            }
        });//end of ajax

        $("#SaleOrderTable").on('change', ".ItemInventoryDropDown", function () {
            debugger

            var ChangedValue = $(this).val();

            var Id = $(this).attr('id');

            let str = Id;
            const myArr = str.split("Stocks");

            var UnitSalePriceOfProduct = 0;
            var QuantityOnHand = 0;
            var UnitName = "";

            ProductsObj.forEach(function (arrayItem) {
                if (arrayItem.ProductId == ChangedValue) {

                    UnitSalePriceOfProduct = arrayItem.UnitSalePrice;
                    QuantityOnHand = arrayItem.QuantityOnHand;
                    UnitName = arrayItem.UnitName;
                }

            });

            $("#SaleUnitPrice" + myArr[1] + "").val(UnitSalePriceOfProduct);
            // $("#StockQuantity" + myArr[1]).prop('max', QuantityOnHand);
            $("#StockQuantity" + myArr[1]).val(1);
            $("#UnitName" + myArr[1]).val(UnitName);
            $("#AvailableQuantity" + myArr[1]).val(QuantityOnHand);

            Total(myArr[1]);

        })

        //ItemSaleUnitPrice

        $("#SaleOrderTable").on('keyup mouseup', "#Discount", function () {

            var Discount = $(this).val();

            CalculateDiscount(Discount);
        })

        $('input[type="number"]').on('keypress', function (event) {
            var regex = new RegExp("^[a-zA-Z0-9]+$");
            var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
            if (!regex.test(key)) {
                event.preventDefault();
                return false;
            }
        });

        $("#btnCancel").click(function () {

            window.location.href = "/Sales/Index";

        })


        $("#SaleOrderTable").on('keyup mouseup', ".ItemSelectionQuantity", function () {

            var Id = $(this).attr('id');

            let str = Id;
            const myArr = str.split("Quantity");

            Total(myArr[1]);
        })


        $("#SaleOrderTable").on('keyup mouseup', ".ItemSaleUnitPrice", function () {

            var Id = $(this).attr('id');

            let str = Id;
            const myArr = str.split("Price");

            // alert(myArr[1]);

            Total(myArr[1]);
        })

        $('#SaleForm').validate({ // initialize the plugin
            rules: {
                Name: {
                    required: true,
                },
                StockQuantity0: {
                    required: true,
                    min: 1,
                }

            },
            submitHandler: function (form) {
                debugger;

                $("#Error").html("");
                var SalesList =
                {
                    InventoryId: '',
                    UnitSalePrice: '',
                    Quantity: '',
                    Cost: '',
                };

                SalesList = [


                ];

                var selectedInventoryArary = [];
                let map = {};
                let result = false;

                for (var i in arr) {

                    var InventorStocks = "InventoryStocks" + arr[i];
                    InventorStocks = document.getElementById(InventorStocks).value;

                    selectedInventoryArary.push(InventorStocks);
                }

                for (let i = 0; i < selectedInventoryArary.length; i++) {
                    // check if object contains entry with this element as key
                    if (map[selectedInventoryArary[i]]) {
                        result = true;
                        // terminate the loop
                        break;
                    }
                    map[selectedInventoryArary[i]] = true;
                }

                if (result) {

                    $("#Error").html("Inventroy Raw Items cannot repeat");
                    return false;
                }
                var TableRow = "";
                for (var i in arr) {

                    if (arr[i] == null)
                        continue;

                    var obj = {};

                    var InventorStocks = "InventoryStocks" + arr[i];
                    var IventoryStocksId = InventorStocks;
                    InventorStocks = document.getElementById(InventorStocks).value;

                    var SaleUnitPrice = "SaleUnitPrice" + arr[i];
                    SaleUnitPrice = document.getElementById(SaleUnitPrice).value;

                    var Quantity = "StockQuantity" + arr[i];
                    Quantity = document.getElementById(Quantity).value;

                    var Cost = "TotalCost" + arr[i];
                    Cost = document.getElementById(Cost).value;

                    obj['InventoryId'] = InventorStocks;
                    obj['UnitSalePrice'] = SaleUnitPrice;
                    obj['Quantity'] = Quantity;
                    obj['Cost'] = Cost;

                    var ProductName = $("#" + IventoryStocksId + " option:selected").text();


                    TableRow = TableRow + "<tr>  <td class='description'>" + ProductName + "</td> <td class='quantity' > &nbsp;&nbsp;&nbsp;&nbsp; " + Quantity + "</td> <td  class='price'>" + SaleUnitPrice + "</td>  <td   class='Amount' >&nbsp; " + Cost + "</td>";

                    SalesList.push(obj);

                }//end of for loop

                var Date = $("#Date").val();

                // var CustomerName = $("#CustomerName").val();
                var Discount = $("#Discount").val();
                var DiscountAmount = $("#DiscountAmount").val();
                var DiscountedPrice = $("#DiscountedPrice").val();
                var GrandTotal = $("#GrandTotal").val();

                var Description = $("#Description").val();
                //alert(CustomerName);



                $.ajax({
                    type: "post",
                    url: "/Sales/SaveSaleOrders",
                    data: { 'Date': Date, 'Description': Description, 'GrandTotal': GrandTotal, 'Discount': DiscountAmount, 'DiscountedPrice': DiscountedPrice, 'SaleOrdersList': SalesList },
                    datatype: "json",
                    cache: false,
                    success: function (data) {
                        debugger
                        if (data.Msg == "Created") {


                            var OrderNo = "Order#" + data.OrderNo;
                            var d = new window.Date();
                            var DateAndTime = d.getDate() + "-" + (d.getMonth() + 1) + "-" + d.getFullYear() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds()
                            // window.location.href = "/Inventory/Inventory";

                            // var CustomerName = $("#CustomerName").val();

                            var DiscountRow = "<tr>  <td style='word-break:break-all;' class='description'>Discount</td>  <td class='quantity'>&nbsp; </td> <td class='price'></td> <td class='Amount'>&nbsp;&nbsp; -" + DiscountAmount + "</td> </tr>";
                            var DiscountedRow = "<tr>  <td style='word-break:break-all;' class='description'>Total</td>  <td class='quantity'>&nbsp; </td> <td class='price'></td> <td class='Amount'>&nbsp;&nbsp;" + DiscountedPrice + "</td> </tr>";

                            $("#ReceiptInner").append('' +
                                '' +

                                '<p class="centered">' +
                                '<b> <span id="OrderNo">' + OrderNo + '</span></b><br />' +
                                '<b> <span id="DateTime">' + DateAndTime + '</span></b> </p>' +
                                ' <br><b>Cashier:</b><b>Bismarck </b> <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' +
                                ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b></b>' +
                                ' </span>' +


                                '<table>' +
                                '<thead>' +
                                '<tr>' +
                                '<th class="description">Item</th>' +
                                '<th class="quantity">Qty</th>' +
                                '<th class="price">Price</th>' +
                                '<th class="Amount">Total</th>' +

                                '</tr>' +
                                '</thead>' +
                                '<tbody id="billbody" style="border: 1px solid black">' + TableRow + '' + DiscountRow + ' ' + DiscountedRow + '</tbody>' +
                                '</table><br><br><br><hr>' +
                                '</div>');

                            //setTimeout(function () {
                            //    // Do something after 1 second

                            //}, 1000);

                            $("#bill").css('display', 'block');
                            Receipt();

                        }

                        else if (data == "Exception") {
                        }
                        else {

                            $("#error").html(data);
                            $("#SaveButton").prop("disabled", false);

                        }

                    }
                })


            }

        })

    })//end of document ready

    var tabindex1 = 5;
    var tabindex2 = 6;
    var tabindex3 = 7;
    var tabindex4 = 8;

    function RawStock() {

        $("#GrandTotalRow").before('<tr id="TableRow' + count + '"><td style="width:20%"> <select tabindex=' + tabindex1 + '   style ="width:200px;" class="form-control drop ItemInventoryDropDown" id="InventoryStocks' + count + '" name="InventoryStocks' + count + '" required>' + ExternalAndProductionList + '</select></td><td><input readonly class="form-control ItemSaleUnitName"  id="UnitName' + count + '" type="text" name="UnitName' + count + '"  /></td><td style="width:15%"> <input  class="form-control ItemSaleUnitPrice" tabindex=' + tabindex2 + ' id="SaleUnitPrice' + count + '" value="0" min="0" type="number" name="SaleUnitPrice' + count + '" required /></td>   <td style="width:15%"><input readonly class="form-control ItemAvailableQuantity" id="AvailableQuantity' + count + '" value="0" type="number" name="AvailableQuantity' + count + '" required /></td><td style="width:15%" > <input class="form-control ItemSelectionQuantity" tabindex=' + tabindex3 + ' id="StockQuantity' + count + '" value="1" min="0" type="number" name="StockQuantity' + count + '" required /></td> <td style="width:15%">  <input readonly type="number" id="TotalCost' + count + '" name="TotalCost' + count + '" class="form-control" value="0" required /></td><td><button tabindex=' + tabindex4 + ' type="button" style="background:#32CD32" id="" class="btn btn-sm btn-default " onclick="RawStock()"><i class="fa fa-plus" style="font-size:12px"></i></button></td><td style="width:15%"><button class="btn btn-sm btn-danger  remove_btn" onclick="Remove(' + count + ')"><i style ="font-size:12px;" class="fa fa-remove"></i></button></td></tr>');

        $(".drop").select2();

        row[count] = count;
        arr[count] = count;
        count = count + 1;


        tabindex1 = tabindex1 + 4;
        tabindex2 = tabindex2 + 4;
        tabindex3 = tabindex3 + 4;
        tabindex4 = tabindex4 + 4;


    }

    function Total(RowNumber) {

        debugger

        var GetUnitSalePrice = $("#SaleUnitPrice" + RowNumber).val();
        var GetUnitQuantity = $("#StockQuantity" + RowNumber).val();


        if (GetUnitSalePrice == "") {
            GetUnitSalePrice = 0;
        }
        if (GetUnitQuantity == "") {

            GetUnitQuantity = 0;

        }

        var Total = parseFloat(GetUnitSalePrice) * parseFloat(GetUnitQuantity);

        $("#TotalCost" + RowNumber).val(Total);

        GrandTotal();

    }

    function GrandTotal() {


        var GrandTotal = 0;

        for (var i in arr) {

            if (arr[i] == null)
                continue;


            var TotalCost = $("#TotalCost" + arr[i]).val();
            GrandTotal = parseFloat(TotalCost) + GrandTotal;

        }

        $("#GrandTotal").val(GrandTotal);

        var Discount = $("#Discount").val();
        CalculateDiscount(Discount);

    }


    function Remove(e) {

        var RowToDelete = "TableRow" + e;
        document.getElementById(RowToDelete).remove();

        arr.splice($.inArray(e, arr), 1);
        GrandTotal();

    }
    function CalculateDiscount(Discount) {


        var GrandTotal = $("#GrandTotal").val();

        var DiscountAmount = parseFloat(GrandTotal) * Discount;

        DiscountAmount = DiscountAmount / 100;
    
        var DiscountedPrice = parseFloat(GrandTotal) - parseFloat(DiscountAmount);


        $("#DiscountAmount").val(parseFloat(DiscountAmount.toFixed(2)));
        $("#DiscountedPrice").val(parseFloat(DiscountedPrice.toFixed(2)));



    }

    function Receipt() {

        var mywindow = window.open('', '', '');
        mywindow.document.write('<html><head><title>' + "" + '</title>  ');
        mywindow.document.write('<style> img {-webkit-print-color-adjust: exact !important;}  td,th,tr,table{border-top: 1px solid black;} td.description,th.description {width: 90px; max-width: 90px;word-break: break-word;}  td.quantity,th.quantity{ width: 40px;max-width: 40px;word-break: break-all;} td.Amount,th.Amount {  width: 60px;max-width: 60px;word-break: break-all;} td.Amount,th.Amount {  width: 60px;max-width: 60px;word-break: break-all;} .centered {text-align: center;align-content: center;} .ticket{width: 230px;max-width:230px;font-size: 12px}  img {  max-width: inherit;  width: inherit;} </style>');
        mywindow.document.write('</head><body >');

        mywindow.document.write(document.getElementById('bill').innerHTML);
        // mywindow.document.write(document.getElementById('bill1').innerHTML);

        mywindow.document.write('</body></html>');
        mywindow.document.close(); // necessary for IE >= 10
        mywindow.focus(); // necessary for IE >= 10*/

        mywindow.print();
        mywindow.close();


        window.location.href = "/Sales/Create";
    }

    function redirect() {

    }
</script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

